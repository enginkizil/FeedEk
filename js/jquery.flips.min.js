(function(a){
  a.fn.flips=function(k){    
    if(this.length == 0) return; //no element found, exit
    if(this.length>1) { this.each(function(){ a(this).flips(k)}); return this; } //we got more than one so handle it
    var e={speed:500,autorun:5000,autorun_delay:0,stop_autorun:false,left_arrow:"&laquo;",right_arrow:"&raquo;",direction:"right",items:1,};
    var j=this;
    var k=a.extend(e,k);
    var h,b,f,g,c,d=[],i=false;
    
    this.initBlocks=function(){
      h=a(".content",j);
      a(".block",j).css("display","block");
      f=-1;
      g=a(".block",h).length;
      var page=0;
      a(".block",h).each(function(){
        a(this).wrapInner('<div class="in"></div');
        a(this).css("left","0px");
        a(this).css("top","0px");
        switch(k.direction){
          case"left":
            a(this).css("left",h.width()-a(this).width()*(page+1));
          break;
          case"right":
            a(this).css("left",a(this).width()*page);
          break;
          case"top":
            a(this).css("top",h.height()-a(this).height()*(page+1));
          break;
          case"bottom":
            a(this).css("top",a(this).height()*page);
          break
        }
        a(this).addClass("page"+(page++))
      });
      
      var m=a(".block",h);
      for(var l=0;l<k.items;l++){
        var n=m[l];d.push(n);a(n).show();f++
      }
      b=a(".navigation",j)
    };
    
    this.prepareNavigation=function(){
      b.append('<div class="btn-left"></div>');
      b.append('<div class="btn-left-dis"></div>');
      b.append('<div class="btn-right"></div>');
      b.append('<div class="btn-right-dis"></div>');
      if(k.left_arrow!=""){
        a(".btn-left",b).html(k.left_arrow);
        a(".btn-left-dis",b).html(k.left_arrow)
      }
      if(k.right_arrow!=""){
        a(".btn-right",b).html(k.right_arrow);
        a(".btn-right-dis",b).html(k.right_arrow)
      }
      a(".btn-right",b).click(function(){
        j.stopAutorun();j.clickRight()
      });
      a(".btn-left",b).click(function(){
        j.stopAutorun();j.clickLeft()
      })
    };
    
    this.clickRight=function(q){
      if(i){return}if(f>=g-1){
        var p=a(".page0",h)
      } else {
        var p=a(".page"+(f+1),h)
      }
      var o={};
      var m={};
      for(var n=0;n<d.length;n++){
        var l=a(d[n]);
        var r=l.position();
        switch(k.direction){
          case"left":o={left:r.left+l.width()};break;
          case"right":o={left:r.left-l.width()};break;
          case"top":o={top:r.top+l.height()};break;
          case"bottom":o={top:r.top-l.height()};break
        }
        l.animate(o,k.speed,"swing")
      }
      switch(k.direction){
        case"left":p.css("left",-p.width());m={left:0};break;
        case"right":p.css("left",h.width());m={left:p.position().left-p.width()};break;
        case"top":p.css("top",-p.height());m={top:0};break;
        case"bottom":p.css("top",h.height());m={top:p.position().top-p.height()};break
      }
      p.animate(m,k.speed,"swing");
      d.shift();
      d.push(p);
      if(f>=g-1){f=0}else{f++}
      j.lockClick();
      j.processArrows()
    };
    
    this.clickLeft=function(){
      if(i){return}
      if(f-k.items<0){
        var p=a(".page"+(g+(f-k.items)),h)
      } else {
        var p=a(".page"+(f-k.items),h)
      }
      var o={};
      var m={};
      for(var n=0;n<d.length;n++){
        var l=a(d[n]);
        var q=l.position();
        switch(k.direction){
          case"left":o={left:q.left-l.width()};break;
          case"right":o={left:q.left+l.width()};break;
          case"top":o={top:q.top-l.height()};break;
          case"bottom":o={top:q.top+l.height()};break
        }
        l.animate(o,k.speed,"swing")
      }
      switch(k.direction){
        case"left":p.css("left",h.width());m={left:p.position().left-p.width()};break;
        case"right":p.css("left",-p.width());m={left:0};break;
        case"top":p.css("top",h.height());m={top:p.position().top-p.height()};break;
        case"bottom":p.css("top",-p.height());m={top:0};break
      }
      p.animate(m,k.speed,"swing");
      d.unshift(p);
      d.pop();
      if(f==0){f=g-1}else{f--}
      j.lockClick();
      j.processArrows()
    };
    
    this.processArrows=function(){
      if(k.items>1){
        a(".btn-left",b).css("display","block");
        a(".btn-left-dis",b).css("display","none");
        a(".btn-right",b).css("display","block");
        a(".btn-right-dis",b).css("display","none")
      } else {
        a(".btn-left",b).css("display",f>0?"block":"none");
        a(".btn-left-dis",b).css("display",f==0?"block":"none");
        a(".btn-right",b).css("display",f<g-1?"block":"none");
        a(".btn-right-dis",b).css("display",f==g-1?"block":"none")
      }
    };
    
    this.startAutorun=function(){
      c=setInterval(j.clickRight,k.autorun)
    };
    
    this.stopAutorun=function(){
      clearInterval(c);
      if(!k.stop_autorun){j.startAutorun()}
    };
    
    this.lockClick=function(){
      i=true;
      setTimeout(j.unlockClick,k.speed+50)
    };
    
    this.unlockClick=function(){i=false};
    
    this.initBlocks();
    this.prepareNavigation();
    this.processArrows();
    if(k.autorun>0){
      if(k.autorun_delay>0){
        setTimeout(this.startAutorun,k.autorun_delay)
      } else {
        this.startAutorun();
      }
    }
  }
})(jQuery);